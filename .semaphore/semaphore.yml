---
version: v1.0
name: Build
agent:
  machine:
    type: e1-standard-2

auto_cancel:
  queued:
    when: "true"
fail_fast:
  stop:
    when: "true"

global_job_config:
  prologue:
    commands_file: commands/set_vars_and_checkout.sh

blocks:
  - name: Verify
    task:
      jobs:
        - name: Maven
          commands:
            - cache restore "maven-${BRANCH_NAME},maven-${MAIN_BRANCH}" &
            - wait

            - cd "${REPO_NAME}"

            - ./mvnw --threads=1.5C verify
      epilogue:
        always:
          commands:
            - |-
              if [[ "$SEMAPHORE_JOB_NAME" = "Gradle" ]]; then
                test-results publish **/target/surefire-reports/*.xml &
                (cache delete "maven-${BRANCH_NAME}" && cache store "maven-${BRANCH_NAME}" ~/.m2) &
                wait
              fi
after_pipeline:
  task:
    jobs:
      - name: Publish Test Results
        commands:
          - test-results gen-pipeline-report
